# Lark报警优化指南

## 问题描述

用户反馈crontab配置导致每5分钟发送一条lark消息，造成报警频繁干扰。

## 问题分析

### 1. 原问题根因

#### 问题1: 每日健康报告重复发送
```bash
# 原逻辑 (有问题)
if [[ "$hour" == "08" && $weekday -le 5 ]]; then
    send_feishu_alert "每日健康报告" "..." "info" "daily_report"
fi
```
- **问题**: 只检查小时为08，未检查分钟
- **结果**: 8:00-8:59期间每5分钟都会发送健康报告

#### 问题2: crontab频繁执行完整监控
```bash
# 原配置 (频繁)
*/5 * * * * monitor  # 每5分钟完整监控，包含日报检查
```
- **问题**: 完整监控包含日报发送逻辑
- **结果**: 增加不必要的报警发送机会

## 解决方案

### 1. 修复每日健康报告逻辑

```bash
# 修复后的逻辑
local hour=$(date +%H)
local minute=$(date +%M)  # 新增分钟检查
local weekday=$(date +%u)
if [[ "$hour" == "08" && "$minute" == "00" && $weekday -le 5 ]]; then
    send_feishu_alert "每日健康报告" "..." "info" "daily_report"
fi
```

**修复要点:**
- ✅ 增加分钟检查: `"$minute" == "00"`
- ✅ 确保只在8:00整点发送
- ✅ 避免8点时段内重复发送

### 2. 优化crontab调度策略

```bash
# 优化后的配置
*/5 * * * * health     # 每5分钟轻量级健康检查
*/15 * * * * monitor   # 每15分钟完整监控检查  
0 8 * * 1-5 monitor    # 每天8:00专门日报
```

**优化要点:**
- ✅ **频繁检查**: `health`模式不发送正常状态报警
- ✅ **定期监控**: 15分钟间隔完整检查，降低频率
- ✅ **专门日报**: 8:00专门执行日报任务

### 3. 报警发送控制逻辑

#### 智能过滤机制
```bash
# 报警发送控制
if [[ "$level" != "info" || "$alert_type" == "recovery" ]]; then
    # 发送error/warning或恢复通知
elif [[ "$level" == "info" && "$alert_type" != "recovery" && "$alert_type" != "daily_report" ]]; then
    log "跳过普通info报警: $title"  # 不发送普通info
    return 0
fi
```

#### 防重复报警机制
```bash
# 30分钟防重复
should_send_alert() {
    local time_diff=$((current_time - last_alert_time))
    if [[ $time_diff -lt 1800 ]]; then
        return 1  # 不发送重复报警
    fi
}
```

## 验证结果

### 1. 修复前状态
- ❌ **8:00-8:59**: 每5分钟发送健康报告  
- ❌ **频繁干扰**: 每小时可能12条消息
- ❌ **无差别报警**: 正常状态也发送消息

### 2. 修复后状态
- ✅ **8:00整点**: 仅发送一次健康报告
- ✅ **智能报警**: 只在异常时发送消息
- ✅ **检查频率**: 每5分钟health + 每15分钟monitor

### 3. 实际测试验证

#### health模式测试
```bash
$ ./mysql_doris_sync_monitor.sh health
[2025-05-27 08:50:32] 作业运行正常: ...
[2025-05-27 08:50:32] 数据一致性检查通过
[2025-05-27 08:50:32] 同步延迟正常，数据及时同步
# ✅ 无lark消息发送
```

#### 当前crontab配置
```bash
*/5 * * * * health     # 轻量级检查，不发送正常报警
*/15 * * * * monitor   # 完整监控，异常时报警
0 8 * * 1-5 monitor    # 工作日8:00日报
0 2 * * 0 cleanup      # 周日清理日志
```

## 报警策略总结

### 📮 发送报警的情况
1. **error级别**: 系统故障、连接失败
2. **warning级别**: 数据差异过大、同步延迟
3. **恢复通知**: 故障自动修复成功
4. **每日报告**: 工作日8:00健康状态 (仅一次)

### 🔇 不发送报警的情况
1. **正常状态**: 作业运行正常
2. **健康检查**: health模式的例行检查
3. **重复报警**: 30分钟内同类型报警
4. **非工作时间**: 周末不发送日报

## 监控策略建议

### 🕐 时间策略
- **5分钟**: 快速发现严重问题 (health)
- **15分钟**: 综合分析和趋势监控 (monitor)
- **每日**: 整体运行状况报告
- **每周**: 日志维护和清理

### 🎯 报警分级
- **立即处理**: error级别，自动重启+人工干预
- **关注观察**: warning级别，持续监控
- **信息通知**: info级别，仅恢复和日报

**优化完成，现在Lark报警更加智能和精准！** 🎉 