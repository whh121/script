# Flinkåº”ç”¨å·¥ç¨‹å¼€å‘è§„åˆ™
# =====================================

## ğŸ¯ é¡¹ç›®æ¦‚è¿°
è¿™æ˜¯ä¸€ä¸ªä¼ä¸šçº§Apache Flinkåº”ç”¨å·¥ç¨‹ï¼ŒåŒ…å«å¤šä¸ªå®æ—¶æ•°æ®å¤„ç†é¡¹ç›®ï¼š
- **kafka2doris**: Kafkaåˆ°Dorisçš„æµå¤„ç†ç®¡é“
- **mysql2doris**: MySQLåˆ°Dorisçš„CDCå’Œæ‰¹å¤„ç†åŒæ­¥
- å®Œæ•´çš„ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ
- æ ‡å‡†åŒ–çš„é¡¹ç›®ç»“æ„å’Œé…ç½®ç®¡ç†

## ğŸ“‹ ä»£ç è§„èŒƒ

### é¡¹ç›®ç»“æ„è§„èŒƒ
1. **æ ‡å‡†åŒ–ç›®å½•ç»“æ„**
   ```
   flink_app/
   â”œâ”€â”€ [é¡¹ç›®å]/
   â”‚   â”œâ”€â”€ README.md              # é¡¹ç›®è¯¦ç»†æ–‡æ¡£
   â”‚   â”œâ”€â”€ scripts/               # SQLè„šæœ¬å’ŒShellè„šæœ¬
   â”‚   â”œâ”€â”€ configs/               # é…ç½®æ–‡ä»¶
   â”‚   â”œâ”€â”€ logs/                  # æ—¥å¿—æ–‡ä»¶
   â”‚   â”œâ”€â”€ docs/                  # é¡¹ç›®æ–‡æ¡£
   â”‚   â”œâ”€â”€ tests/                 # æµ‹è¯•æ–‡ä»¶
   â”‚   â””â”€â”€ checkpoints/           # Flinkæ£€æŸ¥ç‚¹å­˜å‚¨
   ```

2. **æ–‡ä»¶å‘½åè§„èŒƒ**
   - **ç”Ÿäº§ç¯å¢ƒSQL**: `{source}_to_{target}_production.sql`
   - **æµ‹è¯•SQL**: æ”¾å…¥ `tests/` ç›®å½•ï¼Œå‘½åä¸º `test_*.sql`
   - **ç›‘æ§è„šæœ¬**: `*_monitor.py` æˆ– `*_monitor.sh`
   - **é…ç½®è„šæœ¬**: `setup_*.sh`

### SQLæ–‡ä»¶è§„èŒƒ
1. **ç”Ÿäº§ç¯å¢ƒé…ç½®**
   - ç¦ç”¨ `SET sql-client.execution.result-mode=TABLEAU;` ï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰
   - å¿…é¡»åŒ…å«å®Œæ•´çš„checkpointé…ç½®
   - ä½¿ç”¨å›ºå®šå»¶è¿Ÿé‡å¯ç­–ç•¥: `restart-strategy = fixed-delay`
   - è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´å’Œé‡è¯•æ¬¡æ•°

2. **æ£€æŸ¥ç‚¹é…ç½® (é¡¹ç›®ç‹¬ç«‹)**
   ```sql
   -- ä½¿ç”¨é¡¹ç›®ç‹¬ç«‹çš„ç›¸å¯¹è·¯å¾„
   SET 'state.checkpoints.dir' = 'file://./flink_app/[é¡¹ç›®å]/checkpoints';
   SET 'execution.checkpointing.interval' = '60s';
   SET 'execution.checkpointing.mode' = 'EXACTLY_ONCE';
   SET 'execution.checkpointing.timeout' = '600s';
   SET 'state.backend' = 'filesystem';
   ```

3. **å­—æ®µç±»å‹æ˜ å°„**
   ```
   MySQL â†’ Flink ç±»å‹æ˜ å°„ï¼š
   - bigint â†’ BIGINT
   - int/tinyint â†’ INT
   - varchar/text â†’ STRING  
   - datetime/timestamp â†’ TIMESTAMP(3)
   - decimal â†’ DECIMAL(10,2)
   
   Kafka JSON â†’ Flink ç±»å‹æ˜ å°„ï¼š
   - number â†’ BIGINT/INT/DECIMAL
   - string â†’ STRING
   - timestamp â†’ TIMESTAMP(3)
   - boolean â†’ BOOLEAN
   ```

4. **è¡¨ç»“æ„éªŒè¯**
   - åœ¨ç¼–å†™SQLå‰å¿…é¡»éªŒè¯çœŸå®çš„æ•°æ®åº“è¡¨ç»“æ„
   - ä½¿ç”¨ `DESCRIBE table_name` æˆ–è„šæœ¬è·å–å‡†ç¡®schema
   - å­—æ®µåå’Œç±»å‹å¿…é¡»ä¸æºè¡¨å®Œå…¨åŒ¹é…

### Pythonè„šæœ¬è§„èŒƒ
1. **ç¼–ç å’Œå¯¼å…¥**
   ```python
   #!/usr/bin/env python3
   # -*- coding: utf-8 -*-
   ```

2. **æ—¥å¿—é…ç½®**
   - å¿…é¡»åŒæ—¶è¾“å‡ºåˆ°æ–‡ä»¶å’Œæ§åˆ¶å°
   - ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼: `%(asctime)s - %(levelname)s - %(message)s`
   - æ—¥å¿—æ–‡ä»¶å­˜æ”¾åœ¨é¡¹ç›®çš„ `logs/` ç›®å½•
   - æŒ‰å¤©åˆ‡å‰²: `monitor_YYYYMMDD.log`

3. **å¼‚å¸¸å¤„ç†**
   - æ‰€æœ‰å¤–éƒ¨è°ƒç”¨å¿…é¡»åŒ…å«å¼‚å¸¸å¤„ç†
   - ç½‘ç»œè¯·æ±‚è®¾ç½®åˆç†çš„timeout (30ç§’)
   - å¤±è´¥æ—¶å‘é€å‘Šè­¦é€šçŸ¥
   - æœ€å¤§é‡è¯•æ¬¡æ•°: 3æ¬¡

4. **å‘Šè­¦é›†æˆ**
   - ç»Ÿä¸€ä½¿ç”¨é£ä¹¦æœºå™¨äººwebhook: `https://open.larksuite.com/open-apis/bot/v2/hook/3bb8fac6-6a02-498e-804f-48b1b38a6089`
   - æˆåŠŸå’Œå¤±è´¥éƒ½è¦æœ‰é€šçŸ¥
   - å‘Šè­¦æ¶ˆæ¯åŒ…å«æ—¶é—´æˆ³å’Œè¯¦ç»†é”™è¯¯ä¿¡æ¯
   - é¿å…é‡å¤å‘Šè­¦ (ä½¿ç”¨çŠ¶æ€æ–‡ä»¶)

### Shellè„šæœ¬è§„èŒƒ
1. **è„šæœ¬å¤´éƒ¨**
   ```bash
   #!/bin/bash
   # è„šæœ¬æè¿°å’Œç”¨é€”
   # ä½œè€…å’Œæ›´æ–°æ—¶é—´
   ```

2. **è·¯å¾„å¤„ç†**
   ```bash
   # ä½¿ç”¨åŠ¨æ€è·¯å¾„æ£€æµ‹
   SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
   PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
   ```

3. **é”™è¯¯å¤„ç†**
   - ä½¿ç”¨ `set -e` é‡é”™å³åœ
   - é‡è¦æ“ä½œå‰æ£€æŸ¥å‰ç½®æ¡ä»¶
   - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

## ğŸ—‚ï¸ é…ç½®ç®¡ç†

### ç¯å¢ƒé…ç½®
1. **MySQLè¿æ¥**
   - ç”Ÿäº§åº“: `xme-prod-rds-content.chkycqw22fzd.ap-southeast-1.rds.amazonaws.com:3306`
   - ç”¨æˆ·: `content-ro` / å¯†ç : `k5**^k12o`
   - æ•°æ®åº“: `content_data_20250114`

2. **Kafkaé›†ç¾¤ (AWS MSK)**
   ```
   b-1.xmeprodlog.o53475.c3.kafka.ap-southeast-1.amazonaws.com:9092
   b-2.xmeprodlog.o53475.c3.kafka.ap-southeast-1.amazonaws.com:9092  
   b-3.xmeprodlog.o53475.c3.kafka.ap-southeast-1.amazonaws.com:9092
   ```

3. **Dorisé›†ç¾¤**
   - ç”Ÿäº§: `172.31.0.82:8030` / `root` / `JzyZqbx!309`
   - æµ‹è¯•: `10.10.41.243:8030` / `root` / `doris@123`

### æ ‡å‡†Checkpointé…ç½®
```sql
SET 'execution.checkpointing.interval' = '60s';
SET 'execution.checkpointing.mode' = 'EXACTLY_ONCE';
SET 'execution.checkpointing.timeout' = '600s';
SET 'state.backend' = 'filesystem';
SET 'restart-strategy' = 'fixed-delay';
SET 'restart-strategy.fixed-delay.attempts' = '3';
SET 'restart-strategy.fixed-delay.delay' = '30s';
```

## ğŸ“Š ç›‘æ§è§„èŒƒ

### ç›‘æ§æŒ‡æ ‡
1. **Flinké›†ç¾¤å¥åº·çŠ¶æ€** - HTTP APIæ£€æŸ¥
2. **ä½œä¸šè¿è¡ŒçŠ¶æ€** - RUNNING/FAILED/CANCELEDçŠ¶æ€ç›‘æ§
3. **Kafkaæ¶ˆè´¹å»¶è¿Ÿ** - å®æ—¶lagç›‘æ§ (kafka2doris)
4. **MySQL CDCå»¶è¿Ÿ** - binlogä½ç‚¹ç›‘æ§ (mysql2doris)
5. **Doriså†™å…¥æˆåŠŸç‡** - å†™å…¥æ€§èƒ½å’Œé”™è¯¯ç›‘æ§
6. **æ•°æ®åŒæ­¥å»¶è¿Ÿ** - ç«¯åˆ°ç«¯å»¶è¿Ÿç›‘æ§

### ç›‘æ§é¢‘ç‡
- **kafka2doris**: 60ç§’é—´éš”æ£€æŸ¥
- **mysql2doris**: 5åˆ†é’Ÿå¥åº·æ£€æŸ¥ï¼Œ15åˆ†é’Ÿå®Œæ•´ç›‘æ§
- **é›†ç¾¤çŠ¶æ€**: æ¯æ¬¡æ£€æŸ¥éƒ½éªŒè¯

### å‘Šè­¦ç­–ç•¥
- **ç«‹å³å‘Šè­¦**: ä½œä¸šå¤±è´¥ã€é›†ç¾¤å¼‚å¸¸
- **æ¢å¤é€šçŸ¥**: è‡ªåŠ¨é‡å¯æˆåŠŸ
- **å®šæœŸæŠ¥å‘Š**: åŒæ­¥å®ŒæˆçŠ¶æ€
- **çŠ¶æ€ç®¡ç†**: é¿å…é‡å¤å‘Šè­¦

### ç›‘æ§è„šæœ¬è¦æ±‚
- æ£€æŸ¥é—´éš”å¯é…ç½®
- æœ€å¤§å¤±è´¥æ¬¡æ•°: 3æ¬¡
- è‡ªåŠ¨é‡å¯èƒ½åŠ›
- å®Œæ•´çš„æ—¥å¿—è®°å½•
- çŠ¶æ€æ–‡ä»¶ç®¡ç†

## ğŸš€ éƒ¨ç½²è§„èŒƒ

### ç”Ÿäº§éƒ¨ç½²æ£€æŸ¥æ¸…å•
- [ ] SQLæ–‡ä»¶schemaéªŒè¯å®Œæˆ
- [ ] å»é™¤è°ƒè¯•æ¨¡å¼é…ç½® (`TABLEAU` æ¨¡å¼)
- [ ] æ£€æŸ¥ç‚¹è·¯å¾„é…ç½®æ­£ç¡® (é¡¹ç›®ç‹¬ç«‹ç›¸å¯¹è·¯å¾„)
- [ ] å‘Šè­¦webhooké…ç½®æ­£ç¡®
- [ ] ç›‘æ§è„šæœ¬æƒé™è®¾ç½®æ­£ç¡® (`chmod +x`)
- [ ] æ—¥å¿—ç›®å½•å¯å†™
- [ ] ç½‘ç»œè¿æ¥æµ‹è¯•é€šè¿‡
- [ ] é¡¹ç›®README.mdæ–‡æ¡£å®Œæ•´

### å¯åŠ¨å‘½ä»¤æ ‡å‡†
```bash
# Flinké›†ç¾¤
cd /opt/flink && ./bin/start-cluster.sh

# kafka2dorisæµå¤„ç†ä½œä¸š
cd /home/ubuntu/work/script
flink sql-client -f flink_app/kafka2doris/scripts/kafka_to_doris_production.sql

# mysql2doris CDCä½œä¸š
flink sql-client -f flink_app/mysql2doris/scripts/mysql_sync.sql

# ç›‘æ§è„šæœ¬
cd flink_app/kafka2doris && ./scripts/start_monitor.sh start
cd flink_app/mysql2doris && ./scripts/setup_monitor_cron.sh
```

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜
1. **Schemaä¸åŒ¹é…**: ä½¿ç”¨è„šæœ¬éªŒè¯çœŸå®è¡¨ç»“æ„
2. **è¿æ¥å¤±è´¥**: æ£€æŸ¥ç½‘ç»œå’Œè®¤è¯ä¿¡æ¯
3. **Checkpointå¤±è´¥**: æ£€æŸ¥è·¯å¾„æƒé™å’Œç£ç›˜ç©ºé—´
4. **å†…å­˜ä¸è¶³**: è°ƒæ•´TaskManageré…ç½®
5. **Kafkaæ¶ˆè´¹å»¶è¿Ÿ**: æ£€æŸ¥åˆ†åŒºæ•°å’Œå¹¶è¡Œåº¦é…ç½®
6. **Doriså†™å…¥å¤±è´¥**: æ£€æŸ¥è¡¨ç»“æ„å’Œæ•°æ®æ ¼å¼

### æ—¥å¿—ä½ç½®
- **Flinkæ—¥å¿—**: `/opt/flink/log/`
- **é¡¹ç›®ç›‘æ§æ—¥å¿—**: `flink_app/[é¡¹ç›®å]/logs/monitor_*.log`
- **é¡¹ç›®åŒæ­¥æ—¥å¿—**: `flink_app/[é¡¹ç›®å]/logs/*_sync.log`
- **æ£€æŸ¥ç‚¹**: `flink_app/[é¡¹ç›®å]/checkpoints/`

### è°ƒè¯•å·¥å…·
```bash
# æ£€æŸ¥Flinkä½œä¸šçŠ¶æ€
flink list
curl http://localhost:8081/jobs

# æ£€æŸ¥Kafkaè¿é€šæ€§
kafka-console-consumer --bootstrap-server [broker] --topic [topic] --from-beginning

# æ£€æŸ¥MySQLè¿é€šæ€§
mysql -h [host] -P [port] -u [user] -p

# æ£€æŸ¥Dorisè¿é€šæ€§
mysql -h [host] -P 9030 -u [user] -p
```

## ğŸ“ æ–‡æ¡£ç»´æŠ¤

### README.mdè¦æ±‚
- æ¯ä¸ªSQLæ–‡ä»¶çš„çŠ¶æ€æ ‡è®° (âœ… å¯ç”¨ / âš ï¸ æµ‹è¯•ä¸­ / âŒ åºŸå¼ƒ)
- è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œéƒ¨ç½²æ­¥éª¤
- å®Œæ•´çš„é…ç½®å‚æ•°è¯´æ˜
- æ•…éšœæ’é™¤æŒ‡å—
- ç¯å¢ƒé…ç½®å’Œä¾èµ–è¯´æ˜

### ä»£ç æ³¨é‡Š
- SQLæ–‡ä»¶å¿…é¡»åŒ…å«ç”¨é€”ã€çŠ¶æ€ã€æ³¨æ„äº‹é¡¹
- Pythonè„šæœ¬å¿…é¡»æœ‰ç±»å’Œæ–¹æ³•çš„æ–‡æ¡£å­—ç¬¦ä¸²
- å…³é”®é…ç½®é¡¹å¿…é¡»æœ‰æ³¨é‡Šè¯´æ˜
- Shellè„šæœ¬å¿…é¡»æœ‰æ“ä½œè¯´æ˜

## ğŸ”’ å®‰å…¨è§„èŒƒ

### æ•æ„Ÿä¿¡æ¯
- å¯†ç ä½¿ç”¨å ä½ç¬¦æˆ–ç¯å¢ƒå˜é‡
- ç”Ÿäº§é…ç½®ä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- æ—¥å¿—ä¸­ä¸è¾“å‡ºæ•æ„Ÿä¿¡æ¯
- ä½¿ç”¨ `.gitignore` å¿½ç•¥æ•æ„Ÿæ–‡ä»¶

### æƒé™æ§åˆ¶
- è„šæœ¬æ–‡ä»¶è®¾ç½®åˆé€‚çš„æ‰§è¡Œæƒé™ (`chmod +x`)
- æ—¥å¿—æ–‡ä»¶é™åˆ¶è®¿é—®æƒé™
- æ£€æŸ¥ç‚¹ç›®å½•æƒé™æ§åˆ¶
- é…ç½®æ–‡ä»¶åªè¯»æƒé™

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### Flinkè°ƒä¼˜
- æ ¹æ®æ•°æ®é‡è°ƒæ•´å¹¶è¡Œåº¦
- ä¼˜åŒ–ç¼“å†²åŒºå¤§å°å’Œå†…å­˜é…ç½®
- è®¾ç½®åˆç†çš„checkpointé—´éš” (60s)
- ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ

### æ•°æ®åº“ä¼˜åŒ–
- ä½¿ç”¨åˆ†åŒºæé«˜æŸ¥è¯¢æ•ˆç‡
- æ‰¹é‡å†™å…¥ä¼˜åŒ–
- è¿æ¥æ± é…ç½®
- ç´¢å¼•ä¼˜åŒ–å»ºè®®

### Kafkaä¼˜åŒ–
- åˆ†åŒºæ•°ä¸å¹¶è¡Œåº¦åŒ¹é…
- åˆç†çš„æ‰¹é‡å¤§å°
- æ¶ˆè´¹è€…ç»„é…ç½®
- ç›‘æ§æ¶ˆè´¹å»¶è¿Ÿ

## ğŸ”„ é¡¹ç›®ç®¡ç†

### æ·»åŠ æ–°é¡¹ç›®
1. åˆ›å»ºæ ‡å‡†ç›®å½•ç»“æ„
2. å¤åˆ¶æ¨¡æ¿æ–‡ä»¶å’Œé…ç½®
3. æ›´æ–°ä¸»README.md
4. é…ç½®ç‹¬ç«‹æ£€æŸ¥ç‚¹è·¯å¾„
5. ç¼–å†™é¡¹ç›®æ–‡æ¡£

### ç‰ˆæœ¬æ§åˆ¶
- ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬å·
- é‡è¦å˜æ›´è®°å½•åœ¨CHANGELOG
- æ ‡è®°æ–‡ä»¶çŠ¶æ€ (ç”Ÿäº§/æµ‹è¯•/åºŸå¼ƒ)
- å®šæœŸæ¸…ç†åºŸå¼ƒæ–‡ä»¶

### æµ‹è¯•è§„èŒƒ
- æ‰€æœ‰SQLè„šæœ¬æä¾›æµ‹è¯•ç‰ˆæœ¬
- ç›‘æ§è„šæœ¬åŒ…å«å•å…ƒæµ‹è¯•
- éƒ¨ç½²å‰å®Œæ•´åŠŸèƒ½æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•

---
## ğŸ”„ æ›´æ–°è®°å½•
- **2025-05-28**: é‡æ„ä¸ºflink_appå·¥ç¨‹ï¼Œæ”¯æŒå¤šé¡¹ç›®ç®¡ç†
- **2025-05-28**: å®ç°é¡¹ç›®ç‹¬ç«‹æ£€æŸ¥ç‚¹ç®¡ç†
- **2025-05-27**: å®Œå–„kafka2doriså’Œmysql2dorisé¡¹ç›®è§„èŒƒ
- **2025-05-27**: æ›´æ–°ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿè§„èŒƒ

# Flinkåˆ†ç¦»æ¨¡æ¿ç³»ç»Ÿå¼€å‘è§„åˆ™
# ================================

## ğŸ¯ é¡¹ç›®æ¦‚è¿°
è¿™æ˜¯åŸºäºJinja2çš„Flinkåˆ†ç¦»æ¨¡æ¿ç³»ç»Ÿï¼Œå®ç°é…ç½®ã€é€»è¾‘ã€æ¨¡æ¿çš„å®Œå…¨åˆ†ç¦»ã€‚
æ ¸å¿ƒç‰¹æ€§ï¼šç¯å¢ƒå·®å¼‚åŒ–ç®¡ç†ã€çœŸå®Schemaæ£€æµ‹ã€é«˜åº¦å¯æ‰©å±•çš„æ¨¡æ¿å¼•æ“ã€‚

## ğŸ“‹ æ¨¡æ¿å¼€å‘è§„èŒƒ

### 1. SQLæ ¼å¼è§„èŒƒ
- **å­—æ®µæ ¼å¼**: æ¯ä¸ªå­—æ®µå¿…é¡»å•ç‹¬ä¸€è¡Œï¼Œæé«˜å¯è¯»æ€§å’Œç»´æŠ¤æ€§
- **Schemaä¸€è‡´æ€§**: sourceå’Œsinkçš„columnå¿…é¡»ä¸çœŸå®æ•°æ®åº“è¡¨schemaä¿æŒå®Œå…¨ä¸€è‡´
- **åˆ†åŒºå­—æ®µ**: sinkè¡¨å¿…é¡»åŒ…å«partition_dayå­—æ®µï¼Œä»sourceè¡¨çš„created_atæå–ï¼Œæ ¼å¼"yyyy-MM-dd"

```sql
-- âœ… æ­£ç¡®æ ¼å¼ - å­—æ®µåˆ†è¡Œ
CREATE TABLE source_user_interests (
    id BIGINT COMMENT 'ä¸»é”®ID',
    user_id BIGINT COMMENT 'ç”¨æˆ·ID',
    interest_type STRING COMMENT 'å…´è¶£ç±»å‹',
    created_at TIMESTAMP(3) COMMENT 'åˆ›å»ºæ—¶é—´'
);

-- âŒ é”™è¯¯æ ¼å¼ - å­—æ®µåœ¨ä¸€è¡Œ
CREATE TABLE source_user_interests (    id BIGINT COMMENT 'ä¸»é”®ID',    user_id BIGINT COMMENT 'ç”¨æˆ·ID');
```

### 2. æ¨¡æ¿ç»“æ„è§„èŒƒ
```
flink_app/configs/
â”œâ”€â”€ environments/          # ç¯å¢ƒé…ç½®ï¼ˆprod/test/devï¼‰
â”œâ”€â”€ jobs/                 # ä½œä¸šé€»è¾‘å®šä¹‰
â”œâ”€â”€ templates/            # Jinja2 SQLæ¨¡æ¿
â”œâ”€â”€ template_generator.py # æ¨¡æ¿ç”Ÿæˆå™¨
â””â”€â”€ schema_detector.py    # Schemaæ£€æµ‹å™¨
```

### 3. ç¯å¢ƒé…ç½®è§„èŒƒ
- **å®Œå…¨åˆ†ç¦»**: ç¯å¢ƒé…ç½®ã€ä½œä¸šé€»è¾‘ã€SQLæ¨¡æ¿ç‹¬ç«‹ç®¡ç†
- **ç‰¹æ®Šè¡¨é…ç½®**: æ”¯æŒuser_interestsç­‰è¡¨çš„ç‹¬ç«‹æ•°æ®åº“è¿æ¥é…ç½®
- **å·®å¼‚åŒ–ç®¡ç†**: prod/test/devç¯å¢ƒç‹¬ç«‹é…ç½®æ–‡ä»¶

```yaml
# environments/prod.yaml
sources:
  mysql:
    # é€šç”¨é…ç½®
    host: "xme-prod-rds-content.chkycqw22fzd.ap-southeast-1.rds.amazonaws.com"
    
    # ç‰¹æ®Šè¡¨é…ç½®
    user_interests:
      host: "xme-prod-rds-analysis-readonly.chkycqw22fzd.ap-southeast-1.rds.amazonaws.com"
      username: "prod-bigdata-user-interests"
      password: "Dd4.fD3DFDk4.9cc"
      database: "content_behavior"
```

### 4. Schemaæ£€æµ‹è§„èŒƒ
- **çœŸå®è¿æ¥**: ä¼˜å…ˆä½¿ç”¨schema_detector.pyè¿æ¥çœŸå®æ•°æ®åº“è·å–è¡¨ç»“æ„
- **é™çº§ç­–ç•¥**: è¿æ¥å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤schemaï¼Œç¡®ä¿ç”Ÿæˆå™¨ä¸ä¸­æ–­
- **ç±»å‹æ˜ å°„**: MySQLç±»å‹ç²¾ç¡®æ˜ å°„åˆ°Flinkç±»å‹

```python
# MySQL â†’ Flink ç±»å‹æ˜ å°„
'bigint' â†’ 'BIGINT'
'varchar/text' â†’ 'STRING'  
'datetime/timestamp' â†’ 'TIMESTAMP(3)'
'decimal' â†’ 'DECIMAL(10,2)'
```

### 5. Jinja2æ¨¡æ¿è§„èŒƒ
- **æ¨¡æ¿ç»§æ‰¿**: ä½¿ç”¨`{% include %}`å®ç°æ¨¡æ¿å¤ç”¨
- **æ¡ä»¶åˆ¤æ–­**: ä½¿ç”¨`{% if %}`å¤„ç†ç¯å¢ƒå·®å¼‚
- **å˜é‡æ›¿æ¢**: ä½¿ç”¨`{{ variable }}`è¿›è¡ŒåŠ¨æ€æ›¿æ¢
- **å¾ªç¯å¤„ç†**: ä½¿ç”¨`{% for %}`éå†å­—æ®µåˆ—è¡¨

```jinja2
{# å­—æ®µç”Ÿæˆ - æ¯ä¸ªå­—æ®µåˆ†è¡Œ #}
CREATE TABLE {{ source_table_name }} (
{%- for field in schema.source_fields %}
    {{ field.name }} {{ field.flink_type }}
    {%- if field.comment %} COMMENT '{{ field.comment }}'{% endif %}
    {%- if not loop.last %},{% endif %}

{%- endfor %}
);
```

### 6. åˆ†åŒºå­—æ®µç”Ÿæˆè§„èŒƒ
- **ç›®æ ‡è¡¨**: å¿…é¡»åŒ…å«partition_day STRINGå­—æ®µ
- **INSERTè¯­å¥**: å¿…é¡»ç”ŸæˆDATE_FORMAT(created_at, 'yyyy-MM-dd') AS partition_day
- **å­—æ®µä½ç½®**: partition_dayæ”¾åœ¨ç›®æ ‡è¡¨å­—æ®µåˆ—è¡¨æœ€å

```sql
-- Dorisç›®æ ‡è¡¨
CREATE TABLE sink_target_table (
    id BIGINT COMMENT 'ä¸»é”®ID',
    user_id BIGINT COMMENT 'ç”¨æˆ·ID',
    created_at TIMESTAMP(3) COMMENT 'åˆ›å»ºæ—¶é—´',
    partition_day STRING COMMENT 'åˆ†åŒºæ—¥æœŸå­—æ®µï¼Œæ ¼å¼yyyy-MM-dd'
);

-- INSERTè¯­å¥
INSERT INTO sink_target_table
SELECT 
    id,
    user_id,
    created_at,
    DATE_FORMAT(created_at, 'yyyy-MM-dd') AS partition_day
FROM source_table;
```

## ğŸ”§ å¼€å‘å·¥å…·ä½¿ç”¨

### æ¨¡æ¿ç”Ÿæˆå‘½ä»¤
```bash
# MySQL CDCåˆ°Doris (ç”Ÿäº§ç¯å¢ƒ)
python3 template_generator.py \
  --job mysql2doris \
  --env prod \
  --source-table user_interests \
  --target-table xme_ods_user_rds_user_interests_di \
  --source-db behavior \
  --target-db ods

# Kafkaåˆ°Doris (æµ‹è¯•ç¯å¢ƒ)  
python3 template_generator.py \
  --job kafka2doris \
  --env test \
  --source-topic client_cold_start \
  --target-table client_cold_start_test
```

### Schemaæ£€æµ‹æµ‹è¯•
```bash
# æµ‹è¯•schemaæ£€æµ‹å™¨
python3 schema_detector.py
```

## ğŸš€ è´¨é‡æ£€æŸ¥æ¸…å•

### ç”ŸæˆSQLæ£€æŸ¥
- [ ] å­—æ®µæ ¼å¼ï¼šæ¯ä¸ªå­—æ®µå•ç‹¬ä¸€è¡Œ
- [ ] Schemaä¸€è‡´æ€§ï¼šä¸çœŸå®è¡¨ç»“æ„åŒ¹é…
- [ ] åˆ†åŒºå­—æ®µï¼šåŒ…å«partition_dayä¸”é€»è¾‘æ­£ç¡®
- [ ] é…ç½®æ­£ç¡®ï¼šè¿æ¥ä¿¡æ¯ã€è®¤è¯ä¿¡æ¯æ— è¯¯
- [ ] æ¨¡æ¿å˜é‡ï¼šæ‰€æœ‰{{}}éƒ½å·²æ­£ç¡®æ›¿æ¢

### æ¨¡æ¿å¼€å‘æ£€æŸ¥  
- [ ] Jinja2è¯­æ³•ï¼šæ¡ä»¶ã€å¾ªç¯ã€åŒ…å«è¯­æ³•æ­£ç¡®
- [ ] å˜é‡å¼•ç”¨ï¼šé¿å…undefinedå˜é‡é”™è¯¯
- [ ] å­—æ®µéå†ï¼šä½¿ç”¨loop.lastæ­£ç¡®å¤„ç†é€—å·
- [ ] æ³¨é‡Šå®Œæ•´ï¼šæ¨¡æ¿ç”¨é€”å’Œå‚æ•°è¯´æ˜æ¸…æ™°

## ğŸ› å¸¸è§é—®é¢˜è§£å†³

### 1. å­—æ®µæ ¼å¼é—®é¢˜
```jinja2
{# ç¡®ä¿å­—æ®µåˆ†è¡Œæ˜¾ç¤º #}
{%- for field in schema.source_fields %}
    {{ field.name }} {{ field.flink_type }}
    {%- if field.comment %} COMMENT '{{ field.comment }}'{% endif %}
    {%- if not loop.last %},{% endif %}

{%- endfor %}
```

### 2. Schemaæ£€æµ‹å¤±è´¥
- æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæ•°æ®åº“è®¤è¯
- ç¡®ä¿pymysqlå·²å®‰è£…ï¼š`pip3 install pymysql`
- éªŒè¯é…ç½®æ–‡ä»¶ä¸­çš„è¿æ¥ä¿¡æ¯

### 3. æ¨¡æ¿å˜é‡æœªæ›¿æ¢
- æ£€æŸ¥å˜é‡åæ‹¼å†™
- ç¡®è®¤å˜é‡åœ¨æ¨¡æ¿ä¸Šä¸‹æ–‡ä¸­å­˜åœ¨
- ä½¿ç”¨{% if variable %}åšæ¡ä»¶æ£€æŸ¥

## ğŸ“ æ–‡ä»¶å‘½åè§„èŒƒ
- ç¯å¢ƒé…ç½®ï¼š`{env}.yaml` (prod.yaml, test.yaml, dev.yaml)
- ä½œä¸šå®šä¹‰ï¼š`{job_type}.yaml` (mysql2doris.yaml, kafka2doris.yaml)  
- SQLæ¨¡æ¿ï¼š`{component}.sql.jinja2` (mysql_cdc_source.sql.jinja2)
- ç”ŸæˆSQLï¼š`{job_name}_{env}.sql` (mysql2doris_user_interests_prod.sql)

## ğŸ”„ æ›´æ–°è®°å½•
- **2025-05-29**: å»ºç«‹åˆ†ç¦»æ¨¡æ¿ç³»ç»Ÿå¼€å‘è§„èŒƒ
- **2025-05-29**: å®Œå–„Schemaæ£€æµ‹å’Œå­—æ®µæ ¼å¼è¦æ±‚
- **2025-05-29**: æ ‡å‡†åŒ–partition_dayå­—æ®µç”Ÿæˆè§„åˆ™ 